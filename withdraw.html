<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retrait - DELL INVEST</title>
    <style>
        /* Design sombre identique à ton projet */
        body { 
            margin: 0; 
            font-family: 'Segoe UI', sans-serif; 
            background: #0f172a; 
            color: #fff; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
        }
        .container { 
            width: 100%; 
            max-width: 400px; 
            padding: 20px; 
        }
        .header {
            text-align: center;
            padding: 20px 0;
        }
        .withdraw-card { 
            background: #020617; 
            padding: 25px; 
            border-radius: 20px; 
            border: 1px solid #1e293b; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .balance-label { font-size: 14px; color: #94a3b8; }
        .balance-amount { 
            font-size: 24px; 
            font-weight: bold; 
            color: #22c55e; 
            margin: 10px 0 20px 0; 
        }
        label { display: block; text-align: left; font-size: 13px; margin-bottom: 5px; color: #94a3b8; }
        input { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 20px; 
            border-radius: 10px; 
            border: 1px solid #334155; 
            background: #1e293b; 
            color: white; 
            box-sizing: border-box; 
            font-size: 16px;
        }
        button { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 10px; 
            background: #ef4444; 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px;
            transition: 0.3s;
        }
        button:hover { background: #dc2626; }
        .warning-box {
            margin-top: 20px;
            padding: 15px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 10px;
            font-size: 12px;
            color: #f87171;
            line-height: 1.5;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Retrait de Fonds</h2>
    </div>

    <div class="withdraw-card">
        <div class="balance-label">Votre solde actuel</div>
        <div class="balance-amount" id="current-solde">Chargement...</div>
        
        <label>Montant à retirer (Minimum 5000 FC)</label>
        <input type="number" id="amount" placeholder="Ex: 5000">

        <label>Numéro de réception (M-Pesa, Airtel, Orange)</label>
        <input type="text" id="wallet" placeholder="099XXXXXXX">
        
        <button onclick="demanderRetrait()">Confirmer le Retrait</button>
        
        <div class="warning-box">
            ⚠️ <b>Note :</b> Le montant minimum est de 5000 FC. Les retraits sont traités manuellement sous 24h. Des frais de réseau peuvent s'appliquer.
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Ta configuration Firebase (identique à app.js)
    const firebaseConfig = {
        apiKey: "AIzaSyA24pBo8mBWiZssPtep--MMBdB7c8_Lu4U",
        authDomain: "dell-invest.firebaseapp.com",
        projectId: "dell-invest",
        storageBucket: "dell-invest.firebasestorage.app",
        messagingSenderId: "807081599583",
        appId: "1:807081599583:web:e00ec3959bc4acdae031ea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const userPhone = localStorage.getItem("userPhone");

    // Rediriger si non connecté
    if (!userPhone) { window.location.href = "login.html"; }

    // Afficher le solde en direct
    const soldeRef = ref(db, 'users/' + userPhone + '/solde');
    onValue(soldeRef, (snapshot) => {
        const montant = snapshot.val() || 0;
        document.getElementById("current-solde").innerText = montant + " FC";
    });

    // Fonction de demande de retrait
    window.demanderRetrait = async function() {
        const montant = parseFloat(document.getElementById("amount").value);
        const numeroReception = document.getElementById("wallet").value;

        // --- SÉCURITÉ : MINIMUM 5000 FC ---
        if (!montant || montant < 5000) {
            alert("❌ Le montant minimum de retrait est de 5000 FC.");
            return;
        }

        if (!numeroReception || numeroReception.length < 9) {
            alert("❌ Veuillez entrer un numéro de réception valide.");
            return;
        }

        try {
            const userRef = ref(db, 'users/' + userPhone);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                const soldeActuel = snapshot.val().solde || 0;

                if (soldeActuel >= montant) {
                    // 1. Déduire l'argent du solde
                    const nouveauSolde = soldeActuel - montant;
                    await set(ref(db, 'users/' + userPhone + '/solde'), nouveauSolde);

                    // 2. Créer la demande dans le dossier "retraits"
                    const retraitRef = ref(db, 'retraits');
                    await push(retraitRef, {
                        utilisateur: userPhone,
                        montant: montant,
                        numeroReception: numeroReception,
                        date: new Date().toLocaleString(),
                        statut: "En attente"
                    });

                    alert("✅ Demande envoyée ! " + montant + " FC ont été déduits de votre solde.");
                    window.location.href = "profil.html";
                } else {
                    alert("❌ Solde insuffisant pour ce retrait.");
                }
            }
        } catch (error) {
            alert("Une erreur est survenue. Veuillez réessayer.");
        }
    };
</script>

</body>
</html>

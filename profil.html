<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - DELL INVEST</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: url('IMG_2276.jpeg') no-repeat center center fixed; background-size: cover; display: flex; justify-content: center; min-height: 100vh; }
        .main-wrapper { width: 100%; max-width: 450px; padding-bottom: 90px; display: flex; flex-direction: column; }
        .profile-header { background: rgba(26, 35, 126, 0.9); color: white; padding: 40px 20px; text-align: center; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .user-phone { font-size: 1.2rem; font-weight: bold; margin-top: 10px; }
        
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; margin-top: -30px; }
        .stat-box { background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .stat-value { display: block; font-size: 18px; font-weight: bold; color: #1a237e; }

        /* SECTION HISTORIQUE & PRODUITS */
        .products-section { background: rgba(255, 255, 255, 0.95); margin: 10px 20px; padding: 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .products-title { font-size: 14px; font-weight: bold; color: #1a237e; margin-bottom: 10px; }
        
        .history-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-hist { flex: 1; padding: 10px; border: none; border-radius: 10px; font-size: 12px; font-weight: bold; cursor: pointer; color: white; }
        .btn-depot { background: #1a237e; }
        .btn-retrait { background: #ef4444; }

        .product-item { background: #f8fafc; padding: 10px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid #22c55e; display: flex; justify-content: space-between; font-size: 13px; color: #333; }

        /* MODAL POUR HISTORIQUE */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; max-height: 70vh; overflow-y: auto; color: #333; }
        .hist-item { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 13px; display: flex; justify-content: space-between; }

        .menu-list { background: rgba(255, 255, 255, 0.95); margin: 10px 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .menu-link { display: flex; justify-content: space-between; align-items: center; padding: 18px; text-decoration: none; color: #333; border-bottom: 1px solid #f0f0f0; font-size: 15px; }
        .whatsapp-btn { background: #25D366 !important; color: white !important; font-weight: bold; }
        
        .nav-footer { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: white; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #eee; }
        .nav-item { text-decoration: none; color: #999; font-size: 11px; text-align: center; }
        .nav-item.active { color: #1a237e; font-weight: bold; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="profile-header">
        <div style="font-size: 50px;">üë§</div>
        <div class="user-phone" id="display-phone">Chargement...</div>
        <div style="font-size: 12px; opacity: 0.8;">Investisseur DELL Certifi√©</div>
    </div>

    <div class="stats-container">
        <div class="stat-box">
            <span style="font-size: 10px; color: #888;">SOLDE</span>
            <span class="stat-value" id="display-solde">0 FC</span>
        </div>
        <div class="stat-box">
            <span style="font-size: 10px; color: #888;">MES INVITS</span>
            <span class="stat-value" id="display-invite">...</span>
        </div>
    </div>

    <div class="products-section">
        <div class="products-title">üìä Historique & Activit√©s</div>
        
        <div class="history-buttons">
            <button class="btn-hist btn-depot" onclick="showHistory('recharges')">üìú Mes D√©p√¥ts</button>
            <button class="btn-hist btn-retrait" onclick="showHistory('retraits')">üí∏ Mes Retraits</button>
        </div>

        <div class="products-title">üíé Mes Investissements</div>
        <div id="list-produits">
            <p style="font-size:12px; color:#999; text-align:center;">Aucun produit actif</p>
        </div>
    </div>

    <div id="modalHistory" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" style="color:#1a237e; margin-top:0;">Historique</h3>
            <div id="history-content">Chargement...</div>
            <button onclick="closeModal()" style="width:100%; margin-top:20px; padding:10px; border-radius:10px; border:none; background:#eee;">Fermer</button>
        </div>
    </div>

    <div class="menu-list">
        <a href="https://chat.whatsapp.com/FGlMMhRWzKv1OGsDkLDIGL" target="_blank" class="menu-link whatsapp-btn">
            <span>üü¢ Groupe WhatsApp Officiel</span>
            <span>‚ùØ</span>
        </a>
        <a href="recharge.html" class="menu-link"><span>üí≥ D√©p√¥t</span> <span>‚ùØ</span></a>
        <a href="withdraw.html" class="menu-link"><span>üí∏ Retrait</span> <span>‚ùØ</span></a>
        <a href="equipe.html" class="menu-link"><span>üë• Mon √âquipe</span> <span>‚ùØ</span></a>
        <a href="javascript:void(0)" onclick="logoutUser()" class="menu-link" style="color: red; border-bottom: none;">
            <span>üö™ D√©connexion</span>
        </a>
    </div>

    <nav class="nav-footer">
        <a href="dashboard.html" class="nav-item">üè†<br>Accueil</a>
        <a href="vip.html" class="nav-item">üíé<br>Investir</a>
        <a href="equipe.html" class="nav-item">üë•<br>√âquipe</a>
        <a href="profil.html" class="nav-item active">üë§<br>Profil</a>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA24pBo8mBWiZssPtep--MMBdB7c8_Lu4U",
        authDomain: "dell-invest.firebaseapp.com",
        projectId: "dell-invest",
        storageBucket: "dell-invest.firebasestorage.app",
        messagingSenderId: "807081599583",
        appId: "1:807081599583:web:e00ec3959bc4acdae031ea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const userPhone = localStorage.getItem("userPhone");

    if (userPhone) {
        onValue(ref(db, 'users/' + userPhone), (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                document.getElementById("display-phone").innerText = data.phone;
                document.getElementById("display-solde").innerText = (data.solde || 0) + " FC";
                document.getElementById("display-invite").innerText = data.invite || "0";
            }
        });

        onValue(ref(db, 'achats/' + userPhone), (snapshot) => {
            const listDiv = document.getElementById("list-produits");
            if (snapshot.exists()) {
                listDiv.innerHTML = "";
                Object.values(snapshot.val()).forEach(achat => {
                    listDiv.innerHTML += `
                        <div class="product-item">
                            <span><b>${achat.produit}</b></span>
                            <span style="color: #22c55e;">Actif ‚úÖ</span>
                        </div>`;
                });
            }
        });

        // FONCTION HISTORIQUE
        window.showHistory = async function(type) {
            const modal = document.getElementById("modalHistory");
            const content = document.getElementById("history-content");
            const title = document.getElementById("modalTitle");
            
            modal.style.display = "flex";
            title.innerText = type === 'recharges' ? "Historique D√©p√¥ts" : "Historique Retraits";
            content.innerHTML = "Chargement...";

            const path = type; // Dossier 'recharges' ou 'retraits'
            const dbRef = ref(db, path);
            const snapshot = await get(dbRef);

            if (snapshot.exists()) {
                let html = "";
                let count = 0;
                snapshot.forEach((child) => {
                    const data = child.val();
                    // Filtrer pour ne voir que ses propres transactions
                    if (data.utilisateur === userPhone || data.telephone === userPhone || data.demandeur === userPhone) {
                        count++;
                        const statusColor = data.statut === "En attente" ? "orange" : "green";
                        html += `
                            <div class="hist-item">
                                <div>
                                    <b>${data.montant} FC</b><br>
                                    <small>${data.date || ''}</small>
                                </div>
                                <div style="color:${statusColor}; font-weight:bold;">${data.statut || 'Valid√©'}</div>
                            </div>`;
                    }
                });
                content.innerHTML = count > 0 ? html : "Aucune transaction trouv√©e.";
            } else {
                content.innerHTML = "Aucun historique.";
            }
        };

    } else { window.location.href = "login.html"; }

    window.closeModal = () => { document.getElementById("modalHistory").style.display = "none"; };
    window.logoutUser = () => { localStorage.removeItem("userPhone"); window.location.href = "login.html"; };
</script>

</body>
</html>
